<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ToDoæŠ½å‡º - AIãŒã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆ</title>
    <meta name="description" content="YouTubeå‹•ç”»ã®URLã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€AIãŒå†…å®¹ã‚’è§£æã—ã¦ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'midnight': '#0f172a',
                        'deep-blue': '#1e293b',
                        'neon-purple': '#a855f7',
                        'neon-blue': '#3b82f6',
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .glow-effect {
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.3);
            transition: all 0.3s ease;
        }

        .glow-effect:focus {
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.6), 0 0 60px rgba(59, 130, 246, 0.4);
            outline: none;
        }

        .gradient-text {
            background: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #a855f7 0%, #3b82f6 100%);
        }

        .card-glass {
            background: rgba(30, 41, 59, 0.95);
            /* åŠé€æ˜ã‚’æ¸›ã‚‰ã—ã¦æç”»è² è·ã‚’è»½æ¸› */
            border: 1px solid rgba(168, 85, 247, 0.3);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @keyframes wave {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .wave-animation {
            animation: wave 1.5s ease-in-out infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        .pulse-glow {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .task-item {
            transition: all 0.3s ease;
        }

        .task-item:hover {
            transform: translateX(5px);
            background: rgba(168, 85, 247, 0.1);
        }

        .task-item.completed {
            opacity: 0.6;
            text-decoration: line-through;
        }
    </style>
</head>

<body class="bg-midnight min-h-screen text-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        function App() {
            const [url, setUrl] = useState('');
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [result, setResult] = useState(null);
            const [tasks, setTasks] = useState([]);

            const [googleConnected, setGoogleConnected] = useState(false);
            const [taskLists, setTaskLists] = useState([]);
            const [selectedTaskList, setSelectedTaskList] = useState('');
            const [isAddingToGoogle, setIsAddingToGoogle] = useState(false);

            // Googleèªè¨¼çŠ¶æ…‹ã®ç¢ºèª
            React.useEffect(() => {
                checkGoogleStatus();
            }, []);

            const checkGoogleStatus = async () => {
                try {
                    const res = await fetch('/api/google/status');
                    const data = await res.json();
                    if (data.connected) {
                        setGoogleConnected(true);
                        fetchTaskLists();
                    }
                } catch (e) {
                    console.error("Google status check failed", e);
                }
            };

            const fetchTaskLists = async () => {
                try {
                    const res = await fetch('/api/google/tasklists');
                    if (res.ok) {
                        const lists = await res.json();
                        setTaskLists(lists);
                        if (lists.length > 0) {
                            setSelectedTaskList(lists[0].id); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé¸æŠ
                        }
                    }
                } catch (e) {
                    console.error("Fetch tasklists failed", e);
                }
            };

            const handleGoogleLogin = () => {
                window.location.href = '/google/login';
            };

            const addToGoogleTasks = async () => {
                if (!selectedTaskList) {
                    alert("è¿½åŠ å…ˆã®ãƒªã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„");
                    return;
                }

                // ãƒã‚§ãƒƒã‚¯ãŒå…¥ã£ã¦ã„ãªã„ã‚¿ã‚¹ã‚¯ã‚’è¿½åŠ å¯¾è±¡ã¨ã™ã‚‹å ´åˆãŒå¤šã„ãŒã€
                // ã“ã“ã§ã¯ã€Œå®Œäº†ã—ã¦ã„ãªã„ã€ã‚¿ã‚¹ã‚¯ã€ã¾ãŸã¯ã€Œå…¨ã‚¿ã‚¹ã‚¯ã€ãªã©ã‚’ã©ã†ã™ã‚‹ã‹ã€‚
                // è¦æœ›ã¯ã€Œãƒªã‚¹ãƒˆåŒ–ã™ã‚‹æ©Ÿèƒ½ã‚’è¿½åŠ ã—ãŸã„ã€ãªã®ã§ã€
                // ã€Œç”»é¢ä¸Šã§ãƒã‚§ãƒƒã‚¯æ¸ˆã¿(=å®Œäº†)ã®ã‚‚ã®ã€ã‚’é™¤å¤–ã—ã¦è¿½åŠ ã™ã‚‹ã®ãŒè‡ªç„¶ã‹ã€
                // ã‚ã‚‹ã„ã¯ã€Œå…¨ã¦è¿½åŠ ã€ã‹ã€‚
                // NotebookLMã‹ã‚‰ã®ãƒ•ãƒ­ãƒ¼ã‚’è€ƒãˆã‚‹ã¨ã€Œã“ã‚Œã‹ã‚‰ã‚„ã‚‹ã“ã¨ã€ã‚’è¿½åŠ ã—ãŸã„ã¯ãšã€‚

                // ä»Šå›ã¯ã€Œç”»é¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯å…¨ã¦ã€ã‚’è¿½åŠ å¯¾è±¡ã¨ã—ã€
                // å®Œäº†æ¸ˆã¿(completed=true)ã¯é™¤å¤–ã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ã«ã™ã‚‹
                const tasksToAdd = tasks.filter(t => !t.completed).map(t => ({
                    title: t.text,
                    notes: `Source: ${result.title}\nSummary: ${result.summary.substring(0, 100)}...`
                }));

                if (tasksToAdd.length === 0) {
                    alert("è¿½åŠ ã™ã‚‹æœªå®Œäº†ã‚¿ã‚¹ã‚¯ãŒã‚ã‚Šã¾ã›ã‚“");
                    return;
                }

                setIsAddingToGoogle(true);
                try {
                    const res = await fetch('/api/google/tasks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            tasklist_id: selectedTaskList,
                            tasks: tasksToAdd
                        })
                    });

                    const data = await res.json();
                    if (res.ok) {
                        alert(`${data.length}ä»¶ã®ã‚¿ã‚¹ã‚¯ã‚’Google ToDoãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
                    } else {
                        throw new Error(data.error || "è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    }
                } catch (e) {
                    alert(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${e.message}`);
                } finally {
                    setIsAddingToGoogle(false);
                }
            };

            const handleAnalyze = async () => {
                if (!url.trim()) {
                    alert('YouTubeã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                setIsAnalyzing(true);
                setResult(null); // çµæœã‚’ãƒªã‚»ãƒƒãƒˆ

                // URLã‚’æ”¹è¡Œã§åˆ†å‰²ã—ã€ç©ºè¡Œã‚’é™¤å»ã—ã¦é…åˆ—åŒ–
                const urls = url.split('\n').map(u => u.trim()).filter(u => u.length > 0);

                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ urls }), // 'url' ã‹ã‚‰ 'urls' ã«å¤‰æ›´
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'è§£æã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }

                    setResult(data);
                    setTasks(data.tasks);

                } catch (error) {
                    alert(error.message);
                    console.error('Error:', error);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            const toggleTask = (id) => {
                setTasks(tasks.map(task =>
                    task.id === id ? { ...task, completed: !task.completed } : task
                ));
            };

            const copyToClipboard = () => {
                const taskText = tasks.map((task, index) =>
                    `${index + 1}. ${task.text}`
                ).join('\n');
                navigator.clipboard.writeText(taskText);
                alert('ã‚¿ã‚¹ã‚¯ãƒªã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ!');
            };

            const downloadForNotebookLM = () => {
                if (!result) return;

                const content = `ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘
${result.title}

ã€è¦ç´„ã€‘
${result.summary}

ã€ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆã€‘
${tasks.map((t, i) => `${i + 1}. [${t.completed ? 'x' : ' '}] ${t.text}`).join('\n')}

==================================================
ã€å…¨å­—å¹•ãƒ‡ãƒ¼ã‚¿ï¼ˆNotebookLMç”¨ï¼‰ã€‘
${result.transcript || 'ï¼ˆå­—å¹•ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰'}
`;

                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                // ãƒ•ã‚¡ã‚¤ãƒ«åã«ä½¿ãˆãªã„æ–‡å­—ã‚’ç½®æ›
                const safeTitle = result.title.replace(/[\/\\:*?"<>|]/g, '_').substring(0, 50);
                a.download = `${safeTitle}_notebooklm.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            return (
                <div className="min-h-screen py-12 px-4">
                    {/* ãƒ’ãƒ¼ãƒ­ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */}
                    <div className="max-w-4xl mx-auto text-center mb-16">
                        <h1 className="text-5xl md:text-6xl font-bold mb-6">
                            <span className="gradient-text">YouTubeå‹•ç”»ã¾ã¨ã‚</span>
                            <br />
                            <span className="text-white">ä¸€æ‹¬ã§ã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆåŒ–</span>
                        </h1>
                        <p className="text-gray-400 text-lg mb-12">
                            è¤‡æ•°ã®å‹•ç”»URLã‚’è²¼ã‚Šä»˜ã‘ã¦ã€ã¾ã¨ã‚ã¦è¦ç´„ãƒ»ã‚¿ã‚¹ã‚¯æŠ½å‡ºï¼<br />
                            NotebookLMç­‰ã®ãƒªã‚¹ãƒˆæ¶ˆåŒ–ã«æœ€é©ã§ã™ã€‚
                        </p>

                        {/* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  */}
                        <div className="relative mb-8 text-left">
                            <textarea
                                value={url}
                                onChange={(e) => setUrl(e.target.value)}
                                placeholder="YouTubeã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼ˆæ”¹è¡Œã§åŒºåˆ‡ã£ã¦è¤‡æ•°å…¥åŠ›å¯èƒ½ï¼‰"
                                className="w-full px-6 py-4 h-40 rounded-2xl bg-deep-blue text-white placeholder-gray-500 glow-effect text-lg resize-none"
                                disabled={isAnalyzing}
                            />
                        </div>

                        <button
                            onClick={handleAnalyze}
                            disabled={isAnalyzing}
                            className="gradient-bg text-white px-8 py-4 rounded-xl font-semibold text-lg hover:opacity-90 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-lg w-full md:w-auto"
                        >
                            {isAnalyzing ? (
                                <span className="flex items-center justify-center gap-2">
                                    <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                                        <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    AIãŒå‹•ç”»ã‚’è§£æä¸­... (æœ¬æ•°ãŒå¤šã„ã¨æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)
                                </span>
                            ) : 'ã¾ã¨ã‚ã¦è§£æã‚’é–‹å§‹'}
                        </button>
                    </div>

                    {/* è§£æä¸­ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */}
                    {isAnalyzing && (
                        <div className="max-w-4xl mx-auto mb-12">
                            <div className="card-glass rounded-2xl p-8 text-center">
                                <div className="flex justify-center gap-2 mb-4">
                                    <div className="w-3 h-3 bg-neon-purple rounded-full wave-animation" style={{ animationDelay: '0s' }}></div>
                                    <div className="w-3 h-3 bg-neon-blue rounded-full wave-animation" style={{ animationDelay: '0.2s' }}></div>
                                    <div className="w-3 h-3 bg-neon-purple rounded-full wave-animation" style={{ animationDelay: '0.4s' }}></div>
                                </div>
                                <p className="text-gray-300 pulse-glow">
                                    å‹•ç”»ã®å†…å®¹ã‚’èª­ã¿å–ã‚Šã€æƒ…å ±ã‚’çµ±åˆã—ã¦ã„ã¾ã™...<br />
                                    <span className="text-sm text-gray-500">â€»å®Œäº†ã¾ã§ãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„</span>
                                </p>
                            </div>
                        </div>
                    )}

                    {/* çµæœè¡¨ç¤º */}
                    {result && !isAnalyzing && (
                        <div className="max-w-4xl mx-auto space-y-6">

                            {/* çµ±åˆçµæœã‚«ãƒ¼ãƒ‰ */}
                            <div className="card-glass rounded-2xl p-8 border-neon-purple border-2">
                                <div className="flex justify-between items-start mb-4">
                                    <div>
                                        <span className="bg-neon-purple text-xs font-bold px-2 py-1 rounded text-white mb-2 inline-block">çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ</span>
                                        <h2 className="text-2xl font-bold text-white">{result.title}</h2>
                                    </div>
                                </div>
                                <p className="text-gray-300 leading-relaxed mb-6">{result.summary}</p>

                                <div className="bg-deep-blue bg-opacity-50 p-6 rounded-xl">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="text-xl font-bold gradient-text">çµ±åˆã‚„ã‚‹ã“ã¨ãƒªã‚¹ãƒˆ</h3>
                                        <div className="flex gap-2">
                                            <button
                                                onClick={downloadForNotebookLM}
                                                className="text-sm px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 transition-all text-white flex items-center gap-2"
                                                title="NotebookLMç”¨ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"
                                            >
                                                ğŸ“„ å…¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜
                                            </button>
                                            <button
                                                onClick={copyToClipboard}
                                                className="text-sm px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-all text-white"
                                            >
                                                ğŸ“‹ ã‚³ãƒ”ãƒ¼
                                            </button>
                                        </div>
                                    </div>

                                    {/* Google Tasksé€£æº UI */}
                                    <div className="mb-6 p-4 border border-gray-700 rounded-lg bg-black bg-opacity-20">
                                        <div className="flex items-center justify-between flex-wrap gap-4">
                                            <div className="flex items-center gap-2 text-sm text-gray-300">
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5b/Google_Tasks_2021.svg" alt="Google Tasks" className="w-5 h-5" />
                                                Google ToDoãƒªã‚¹ãƒˆé€£æº
                                            </div>

                                            {!googleConnected ? (
                                                <button
                                                    onClick={handleGoogleLogin}
                                                    className="text-sm px-4 py-2 rounded-lg bg-white text-gray-800 font-bold hover:bg-gray-100 transition-all flex items-center gap-2"
                                                >
                                                    Googleã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§æ¥ç¶š
                                                </button>
                                            ) : (
                                                <div className="flex items-center gap-2 w-full sm:w-auto">
                                                    <select
                                                        value={selectedTaskList}
                                                        onChange={(e) => setSelectedTaskList(e.target.value)}
                                                        className="text-sm bg-deep-blue border border-gray-600 text-white rounded-lg px-3 py-2 focus:outline-none focus:border-neon-purple flex-1 sm:flex-none"
                                                    >
                                                        {taskLists.map(list => (
                                                            <option key={list.id} value={list.id}>{list.title}</option>
                                                        ))}
                                                    </select>
                                                    <button
                                                        onClick={addToGoogleTasks}
                                                        disabled={isAddingToGoogle}
                                                        className="text-sm px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all disabled:opacity-50 min-w-[100px]"
                                                    >
                                                        {isAddingToGoogle ? 'è¿½åŠ ä¸­...' : 'è¿½åŠ '}
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    <div className="space-y-3">
                                        {tasks.map((task) => (
                                            <div
                                                key={task.id}
                                                onClick={() => toggleTask(task.id)}
                                                className={`task-item flex items-start gap-3 p-4 rounded-xl cursor-pointer ${task.completed ? 'completed' : ''}`}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={task.completed}
                                                    onChange={() => { }}
                                                    className="mt-1 w-5 h-5 rounded accent-neon-purple cursor-pointer"
                                                />
                                                <span className="flex-1 text-gray-200">{task.text}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* å€‹åˆ¥çµæœã®è¡¨ç¤ºï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰ */}
                            {result.individual_results && result.individual_results.length > 0 && (
                                <div className="mt-12">
                                    <h3 className="text-xl text-gray-400 mb-6 text-center">å€‹åˆ¥å‹•ç”»ã®è§£æçµæœ ({result.individual_results.length}æœ¬)</h3>
                                    <div className="space-y-6">
                                        {result.individual_results.map((res, idx) => (
                                            !res.error && (
                                                <div key={idx} className="card-glass rounded-2xl p-6 opacity-80 hover:opacity-100 transition-all">
                                                    <h4 className="text-lg font-bold text-white mb-2">
                                                        <span className="text-neon-blue mr-2">#{idx + 1}</span>
                                                        {res.title}
                                                    </h4>
                                                    <p className="text-sm text-gray-300 mb-4">{res.summary}</p>

                                                    {res.tasks && (
                                                        <div className="text-sm text-gray-400">
                                                            <p className="font-semibold mb-1">æŠ½å‡ºã•ã‚ŒãŸã‚¿ã‚¹ã‚¯:</p>
                                                            <ul className="list-disc list-inside bg-black bg-opacity-20 p-3 rounded-lg">
                                                                {res.tasks.slice(0, 3).map((t, ti) => (
                                                                    <li key={ti} className="truncate">{t.text}</li>
                                                                ))}
                                                                {res.tasks.length > 3 && <li>...ä»– {res.tasks.length - 3} ä»¶</li>}
                                                            </ul>
                                                        </div>
                                                    )}
                                                </div>
                                            )
                                        ))}
                                    </div>
                                </div>
                            )}

                        </div>
                    )}

                    {/* ãƒ•ãƒƒã‚¿ãƒ¼ */}
                    <div className="max-w-4xl mx-auto mt-16 text-center text-gray-500 text-sm">
                        <p>Powered by Google Gemini AI</p>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>

</html>